# Backend Repasoft
#### Trabajo de Final de Grado: Adri√°n Ucha Sousa

## Descripici√≥n del proyecto.
[Pendiente agregar]

---

## Instalaci√≥n y configuraci√≥n del entorno con Laravel Sail y PostgresSQL
### Requisitos previos:
- Docker instalado y funcional en nuestro ordenador.
- Composer para la gesti√≥n de dependencias.
- PHP 8.2 (Necesario para que funcione, ya que requiere de PHP).
- IDE (Opcional para visualizaci√≥n c√≥moda de c√≥digo y entorno de trabajo).

Una vez cumplimos los requisitos

### Clonaci√≥n el repositorio


````shell
    # Comando de clonaci√≥n de proyecto
    git clone https://github.com/Uchaa03/Repasoft_Backend.git

    # Vamos al directorio una vez clonado
    cd Repasoft_Backend
````

### Instalaci√≥n de Sail en el proyecto

Seleccionamos el servicio psql(PostgresSQL), al instalar sail.

````shell
    # Instalaci√≥n de dependencia sail en el proyecto
    composer require laravel/sail --dev
    
    # Comando de configuraci√≥n de la dependencia instalada
    php artisan sail:install
````

**Importante: Revisar que `.env` sea como √©l `.env.example` se debe de configurar con la instalaci√≥n de sail, de lo
contrario debemos hacerlo manualmente**

Una vez realizado esto, se configurar√°n los contenedores en docker para que los podamos lanzar con sail.
````shell
    # Comando para aplicar alias a sail
    alias sail='[ -f sail ] && sh sail || sh vendor/bin/sail'

    # Comando de inicio
    sail up -d
    
    # Parar contenedores
    sail down
    
    # Borrar contenedores para poder lanzarlos limpios
    sail down -v

````

### Ejecutar migraciones y seeders
Debemos de ejecutar las migraciones y lanzar los seeders para que la aplicaci√≥n funcione correctamente.
````shell
    # Comando para migraciones
    sail artisan migrate
    
    # Comando para seeders(roles)
    sail artisan db:seed
````
Una vez realizado todo ya tendremos listo nuestro backend para realizar las pruebas necesarias.


## Dise√±o del modelo de usuario

### Opciones consideradas

1. **Modelo √∫nico `User` con campos opcionales y roles**
    - Todos los tipos de usuario (administrador, t√©cnico, cliente) comparten la misma tabla.
    - Los campos espec√≠ficos de cada tipo se definen como opcionales (`nullable`).
    - Un campo `role` diferencia el tipo de usuario.
    - Sencillez en autenticaci√≥n y gesti√≥n de permisos.

2. **Modelo principal `User` + modelos extendidos (`Technician`, `Client`)**
    - Tabla `users` para datos comunes.
    - Tablas `technicians` y `clients` para los datos espec√≠ficos, enlazadas por `user_id`.
    - Mayor normalizaci√≥n, pero m√°s complejidad en consultas y relaciones.

3. **Single Table Inheritance (STI)**
    - Un campo `type` o `role` en la tabla `users` y l√≥gica de herencia a nivel de modelo.
    - No es nativo en Laravel y puede complicar el mantenimiento.

### Opci√≥n elegida y justificaci√≥n

**Se ha optado por un √∫nico modelo `User` con campos opcionales y un campo `role`.**

- Permite gestionar todos los usuarios desde una sola tabla y modelo.
- Facilita la integraci√≥n con paquetes de roles y permisos como [spatie/laravel-permission](https://spatie.be/docs/laravel-permission).
- Simplifica la autenticaci√≥n y el control de acceso.
- Es f√°cilmente escalable y suficientemente flexible para los requisitos actuales del proyecto.

Los campos espec√≠ficos de t√©cnicos o clientes (por ejemplo, `dni`, `address`, `phone`, `rating`, `repairs_count`, `profile_photo`, `password_changed`) se definen como opcionales y solo se utilizan seg√∫n el tipo de usuario.

---

# üìö Modelos y Estructura de Datos

## üìÑ Modelo de Usuario (`users`)

### **Estructura y dise√±o**
El modelo de usuario centraliza la gesti√≥n de todos los tipos de usuarios de la aplicaci√≥n: **administradores, t√©cnicos y clientes**. Se utiliza un √∫nico modelo con un campo `role` para diferenciar los tipos de usuario, y campos opcionales (`nullable`) para los atributos espec√≠ficos de cada rol.

### **Campos de la tabla `users`**

| Campo             | Tipo      | Descripci√≥n                                                     |
|-------------------|-----------|-----------------------------------------------------------------|
| id                | bigint    | Identificador √∫nico (autoincremental)                           |
| name              | string    | Nombre completo del usuario                                     |
| email             | string    | Correo electr√≥nico (√∫nico)                                      |
| email_verified_at | timestamp | Fecha de verificaci√≥n del correo (opcional)                     |
| password          | string    | Contrase√±a cifrada                                              |
| role              | enum      | Rol del usuario: `admin`, `technician` o `client`               |
| password_changed  | boolean   | Indica si el usuario ha cambiado la contrase√±a inicial          |
| dni               | string    | Documento de identidad (opcional, √∫nico para t√©cnicos/clientes) |
| address           | string    | Direcci√≥n (opcional)                                            |
| phone             | string    | Tel√©fono (opcional)                                             |
| profile_photo     | string    | Ruta de la foto de perfil (opcional, t√©cnicos)                  |
| rating            | float     | Valoraci√≥n media (opcional, t√©cnicos)                           |
| repairs_count     | integer   | N√∫mero de reparaciones realizadas (opcional, t√©cnicos)          |
| store_id          | foreignId | Tienda asociada (opcional, t√©cnicos)                            |
| remember_token    | string    | Token de sesi√≥n (Laravel)                                       |
| created_at        | timestamp | Fecha de creaci√≥n                                               |
| updated_at        | timestamp | Fecha de √∫ltima actualizaci√≥n                                   |

---

## üè¨ Modelo de Tienda (`stores`)

### **Estructura y dise√±o**
El modelo de tienda centraliza la informaci√≥n de cada sucursal o punto de servicio. Cada tienda puede tener varios t√©cnicos asociados y m√∫ltiples reparaciones.

### **Campos de la tabla `stores`**

| Campo      | Tipo      | Descripci√≥n                         |
|------------|-----------|-------------------------------------|
| id         | bigint    | Identificador √∫nico                 |
| name       | string    | Nombre de la tienda                 |
| address    | string    | Direcci√≥n f√≠sica de la tienda       |
| created_at | timestamp | Fecha de creaci√≥n                   |
| updated_at | timestamp | Fecha de √∫ltima actualizaci√≥n       |

#### **Relaciones y m√©tricas**
- **T√©cnicos asociados:** Relaci√≥n 1:N (`store` tiene muchos `users` con `role = technician`)
- **Reparaciones:** Relaci√≥n 1:N (`store` tiene muchas `repairs`)
- **Ganancias y p√©rdidas:** Calculadas din√°micamente sumando los costes de las reparaciones asociadas (ver m√©todos en el modelo).
- **Rating medio:** Promedio de las valoraciones de las reparaciones asociadas.

---

## üõ†Ô∏è Modelo de Reparaciones (`repairs`)

### **Estructura y dise√±o**
El modelo de reparaciones gestiona todas las incidencias y servicios realizados. Cada reparaci√≥n est√° asociada a un cliente, un t√©cnico, una tienda y puede tener m√∫ltiples piezas asociadas.

### **Campos de la tabla `repairs`**

| Campo         | Tipo      | Descripci√≥n                                                    |
|---------------|-----------|----------------------------------------------------------------|
| id            | bigint    | Identificador √∫nico                                            |
| ticket_number | string    | C√≥digo √∫nico de ticket generado autom√°ticamente                |
| status        | enum      | Estado: `pending`, `in_progress`, `completed`                  |
| store_id      | foreignId | Tienda asociada                                                |
| client_id     | foreignId | Usuario cliente asociado                                       |
| technician_id | foreignId | Usuario t√©cnico asignado (nullable)                            |
| hours         | integer   | Horas de mano de obra                                          |
| labor_cost    | decimal   | Coste total de mano de obra (horas x 30‚ÄØ‚Ç¨)                     |
| parts_cost    | decimal   | Coste total de piezas asociadas                                |
| total_cost    | decimal   | Coste final editable (mano de obra + piezas)                   |
| is_warranty   | boolean   | Indica si la reparaci√≥n est√° en garant√≠a                       |
| rating        | float     | Valoraci√≥n del cliente (1-5 estrellas, nullable)               |
| description   | text      | Descripci√≥n de la reparaci√≥n                                   |
| finished_at   | timestamp | Fecha de finalizaci√≥n (opcional)                               |
| created_at    | timestamp | Fecha de creaci√≥n                                              |
| updated_at    | timestamp | Fecha de √∫ltima actualizaci√≥n                                  |

#### **Relaciones**
- Pertenece a un cliente (`users`)
- Pertenece a un t√©cnico (`users`)
- Pertenece a una tienda (`stores`)
- Tiene muchas piezas asociadas (relaci√≥n muchos a muchos con `parts`)

---

## üß© Modelo de Piezas (`parts`)

### **Estructura y dise√±o**
El modelo de piezas gestiona el inventario de componentes disponibles para las reparaciones.

### **Campos de la tabla `parts`**

| Campo         | Tipo      | Descripci√≥n                                       |
|---------------|-----------|---------------------------------------------------|
| id            | bigint    | Identificador √∫nico                               |
| name          | string    | Nombre de la pieza                                |
| serial_number | string    | N√∫mero de serie (opcional, √∫nico)                 |
| stock         | integer   | Cantidad disponible en inventario                 |
| cost          | decimal   | Coste de compra para la tienda                    |
| price         | decimal   | Precio de venta al cliente                        |
| created_at    | timestamp | Fecha de creaci√≥n                                 |
| updated_at    | timestamp | Fecha de √∫ltima actualizaci√≥n                     |

#### **Relaciones**
- Puede estar asociada a muchas reparaciones (relaci√≥n muchos a muchos con `repairs`)

---

## üîó Tabla pivote `part_repair`

| Campo      | Tipo      | Descripci√≥n                                       |
|------------|-----------|---------------------------------------------------|
| id         | bigint    | Identificador √∫nico                               |
| part_id    | foreignId | ID de la pieza                                    |
| repair_id  | foreignId | ID de la reparaci√≥n                               |
| quantity   | integer   | Cantidad de piezas usadas en esa reparaci√≥n       |
| created_at | timestamp | Fecha de creaci√≥n                                 |
| updated_at | timestamp | Fecha de √∫ltima actualizaci√≥n                     |

---

## **Decisiones de dise√±o y ventajas**

- **Modelo √∫nico para usuarios:** Simplifica la gesti√≥n y autenticaci√≥n.
- **Relaciones claras y normalizadas:** Uso de claves for√°neas y tabla pivote para integridad y consultas eficientes.
- **M√©tricas y estad√≠sticas:** Ganancias, p√©rdidas y rating medio calculados din√°micamente.
- **Escalabilidad:** Estructura preparada para a√±adir nuevos roles, m√≥dulos o funcionalidades f√°cilmente.
- **Facilidad de mantenimiento:** Todas las relaciones y dependencias est√°n bien definidas y documentadas.

---

## **Ejemplo de relaciones Eloquent**

```php
// Obtener todas las reparaciones de una tienda
$store->repairs;

// Obtener t√©cnicos de una tienda
$store->technicians;

// Obtener piezas usadas en una reparaci√≥n
$repair->parts;

// Obtener reparaciones donde se us√≥ una pieza
$part->repairs;

// Calcular ganancias de una tienda
$store->total_earnings;

// Calcular p√©rdidas por garant√≠as de una tienda
$store->total_losses;
```

---
